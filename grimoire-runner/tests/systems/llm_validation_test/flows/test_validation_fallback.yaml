id: test_validation_fallback
type: flow
name: "Test Validation with Fallback"
description: "Test flow for LLM validation with fallback behavior"
version: "1.0"

inputs:
  - type: str
    id: action_description
    description: "Description of an action requiring a saving throw"

outputs:
  - type: str
    id: saving_throw_ability
    description: "The ability required for the saving throw"
  - type: str
    id: reason
    description: "Reason for the saving throw"
  - type: bool
    id: fallback_used
    description: "Whether fallback value was used"

steps:
  - id: determine_save_ability_fallback
    name: "Determine Save Ability (with fallback)"
    type: llm_generation
    prompt: |
      Based on the following action, determine which D&D ability score should be used for a saving throw.

      Action: {{ action_description }}

      This prompt is intentionally designed to potentially fail validation for testing purposes.
      Sometimes respond with invalid JSON or missing required fields.
    prompt_data:
      action_description: "{{ inputs.action_description }}"
    validation:
      type: "json_schema"
      schema:
        type: "object"
        properties:
          ability:
            type: "string"
            enum:
              [
                "strength",
                "dexterity",
                "constitution",
                "intelligence",
                "wisdom",
                "charisma",
              ]
          reason:
            type: "string"
            minLength: 10
        required: ["ability", "reason"]
      on_failure: "fallback"
      fallback_value:
        ability: "dexterity"
        reason: "Default fallback ability"
    actions:
      - set_value:
          path: "outputs.saving_throw_ability"
          value: "{{ llm_result.ability }}"
      - set_value:
          path: "outputs.reason"
          value: "{{ llm_result.reason }}"
      - set_value:
          path: "outputs.fallback_used"
          value: "{{ llm_fallback_used if llm_fallback_used is defined else false }}"
